<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="Hugo 0.88.1" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="" />
  <meta property="og:url" content="https://idreamshen.github.io/posts/thread-status-from-jdk-hotspot/" />
  <link rel="canonical" href="https://idreamshen.github.io/posts/thread-status-from-jdk-hotspot/" /><link rel="alternate" type="application/atom+xml" href="https://idreamshen.github.io/index.xml" title="ChenHsingYu">

  <script type="application/ld+json">
  {
      "@context" : "http://schema.org",
      "@type" : "BlogPosting",
      "mainEntityOfPage": {
           "@type": "WebPage",
           "@id": "https:\/\/idreamshen.github.io\/"
      },
      "articleSection" : "posts",
      "name" : "从 JDK Hotspot 源码探讨线程状态",
      "headline" : "从 JDK Hotspot 源码探讨线程状态",
      "description" : "src\/share\/vm\/classfile\/javaClasses.hpp\n\/\/ Java Thread Status for JVMTI and M\u0026amp;M use. \/\/ This thread status info is saved in threadStatus field of \/\/ java.lang.Thread java class. enum ThreadStatus { NEW = 0, RUNNABLE = JVMTI_THREAD_STATE_ALIVE \u002b \/\/ runnable \/ running JVMTI_THREAD_STATE_RUNNABLE, SLEEPING = JVMTI_THREAD_STATE_ALIVE \u002b \/\/ Thread.sleep() JVMTI_THREAD_STATE_WAITING \u002b JVMTI_THREAD_STATE_WAITING_WITH_TIMEOUT \u002b JVMTI_THREAD_STATE_SLEEPING, IN_OBJECT_WAIT = JVMTI_THREAD_STATE_ALIVE \u002b \/\/ Object.wait() JVMTI_THREAD_STATE_WAITING \u002b JVMTI_THREAD_STATE_WAITING_INDEFINITELY \u002b JVMTI_THREAD_STATE_IN_OBJECT_WAIT, IN_OBJECT_WAIT_TIMED = JVMTI_THREAD_STATE_ALIVE \u002b \/\/ Object.wait(long) JVMTI_THREAD_STATE_WAITING \u002b JVMTI_THREAD_STATE_WAITING_WITH_TIMEOUT \u002b JVMTI_THREAD_STATE_IN_OBJECT_WAIT, PARKED = JVMTI_THREAD_STATE_ALIVE \u002b \/\/ LockSupport.",
      "inLanguage" : "en-US",
      "author" : "",
      "creator" : "",
      "publisher": "",
      "accountablePerson" : "",
      "copyrightHolder" : "",
      "copyrightYear" : "2018",
      "datePublished": "2018-04-11 13:54:13 \u002b0800 CST",
      "dateModified" : "2018-04-11 13:54:13 \u002b0800 CST",
      "url" : "https:\/\/idreamshen.github.io\/posts\/thread-status-from-jdk-hotspot\/",
      "keywords" : [  ]
  }
</script>
<title>从 JDK Hotspot 源码探讨线程状态 - ChenHsingYu</title>
  <meta property="og:title" content="从 JDK Hotspot 源码探讨线程状态 - ChenHsingYu" />
  <meta property="og:type" content="article" />
  <meta property="og:description" content="src/share/vm/classfile/javaClasses.hpp
// Java Thread Status for JVMTI and M&amp;M use. // This thread status info is saved in threadStatus field of // java.lang.Thread java class. enum ThreadStatus { NEW = 0, RUNNABLE = JVMTI_THREAD_STATE_ALIVE &#43; // runnable / running JVMTI_THREAD_STATE_RUNNABLE, SLEEPING = JVMTI_THREAD_STATE_ALIVE &#43; // Thread.sleep() JVMTI_THREAD_STATE_WAITING &#43; JVMTI_THREAD_STATE_WAITING_WITH_TIMEOUT &#43; JVMTI_THREAD_STATE_SLEEPING, IN_OBJECT_WAIT = JVMTI_THREAD_STATE_ALIVE &#43; // Object.wait() JVMTI_THREAD_STATE_WAITING &#43; JVMTI_THREAD_STATE_WAITING_INDEFINITELY &#43; JVMTI_THREAD_STATE_IN_OBJECT_WAIT, IN_OBJECT_WAIT_TIMED = JVMTI_THREAD_STATE_ALIVE &#43; // Object.wait(long) JVMTI_THREAD_STATE_WAITING &#43; JVMTI_THREAD_STATE_WAITING_WITH_TIMEOUT &#43; JVMTI_THREAD_STATE_IN_OBJECT_WAIT, PARKED = JVMTI_THREAD_STATE_ALIVE &#43; // LockSupport." />
  <meta name="description" content="src/share/vm/classfile/javaClasses.hpp
// Java Thread Status for JVMTI and M&amp;M use. // This thread status info is saved in threadStatus field of // java.lang.Thread java class. enum ThreadStatus { NEW = 0, RUNNABLE = JVMTI_THREAD_STATE_ALIVE &#43; // runnable / running JVMTI_THREAD_STATE_RUNNABLE, SLEEPING = JVMTI_THREAD_STATE_ALIVE &#43; // Thread.sleep() JVMTI_THREAD_STATE_WAITING &#43; JVMTI_THREAD_STATE_WAITING_WITH_TIMEOUT &#43; JVMTI_THREAD_STATE_SLEEPING, IN_OBJECT_WAIT = JVMTI_THREAD_STATE_ALIVE &#43; // Object.wait() JVMTI_THREAD_STATE_WAITING &#43; JVMTI_THREAD_STATE_WAITING_INDEFINITELY &#43; JVMTI_THREAD_STATE_IN_OBJECT_WAIT, IN_OBJECT_WAIT_TIMED = JVMTI_THREAD_STATE_ALIVE &#43; // Object.wait(long) JVMTI_THREAD_STATE_WAITING &#43; JVMTI_THREAD_STATE_WAITING_WITH_TIMEOUT &#43; JVMTI_THREAD_STATE_IN_OBJECT_WAIT, PARKED = JVMTI_THREAD_STATE_ALIVE &#43; // LockSupport." />
  <meta property="og:locale" content="zh-cn" />

  <link rel="stylesheet" href="/css/flexboxgrid-6.3.1.min.css" />
  <link rel="stylesheet" href="/css/github-markdown.css" />
  <link rel="stylesheet" href="/css/highlight/tomorrow.min.css" />
  <link rel="stylesheet" href="/css/index.css">

  

  <link href="/index.xml" rel="alternate" type="application/rss+xml"
    title="ChenHsingYu">
  
  <link href="https://fonts.googleapis.com/css?family=Arvo|Permanent+Marker|Bree+Serif" rel="stylesheet">
  
  

  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-49492756-1"></script><script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag("js", new Date());gtag("config", "UA-49492756-1");</script>
</head>

<body>
  <article class="post " id="article">
    <div class="row">
      <div class="col-xs-12">
        <div class="site-header">
          
<header>
  <div class="signatures site-title">
    <a href="/">ChenHsingYu</a>
  </div>
</header>
<div class="row end-xs">
  
  
</div>
<div class="header-line"></div>

        </div>
        <header class="post-header">
          <h1 class="post-title">从 JDK Hotspot 源码探讨线程状态</h1>
          
          <div class="row post-desc">
            <div class="col-xs-6">
              
              <time class="post-date" datetime="2018-04-11 13:54:13 CST">
                11 Apr 2018
              </time>
              
            </div>
            <div class="col-xs-6">
              
            </div>
          </div>
          
        </header>

        <div class="post-content markdown-body">
          
          <p>
src/share/vm/classfile/javaClasses.hpp</p>
<div class="src src-cpp -n 380">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">// Java Thread Status for JVMTI and M&amp;M use.
// This thread status info is saved in threadStatus field of
// java.lang.Thread java class.
enum ThreadStatus {
  NEW                      = 0,
  RUNNABLE                 = JVMTI_THREAD_STATE_ALIVE +          // runnable / running
                             JVMTI_THREAD_STATE_RUNNABLE,
  SLEEPING                 = JVMTI_THREAD_STATE_ALIVE +          // Thread.sleep()
                             JVMTI_THREAD_STATE_WAITING +
                             JVMTI_THREAD_STATE_WAITING_WITH_TIMEOUT +
                             JVMTI_THREAD_STATE_SLEEPING,
  IN_OBJECT_WAIT           = JVMTI_THREAD_STATE_ALIVE +          // Object.wait()
                             JVMTI_THREAD_STATE_WAITING +
                             JVMTI_THREAD_STATE_WAITING_INDEFINITELY +
                             JVMTI_THREAD_STATE_IN_OBJECT_WAIT,
  IN_OBJECT_WAIT_TIMED     = JVMTI_THREAD_STATE_ALIVE +          // Object.wait(long)
                             JVMTI_THREAD_STATE_WAITING +
                             JVMTI_THREAD_STATE_WAITING_WITH_TIMEOUT +
                             JVMTI_THREAD_STATE_IN_OBJECT_WAIT,
  PARKED                   = JVMTI_THREAD_STATE_ALIVE +          // LockSupport.park()
                             JVMTI_THREAD_STATE_WAITING +
                             JVMTI_THREAD_STATE_WAITING_INDEFINITELY +
                             JVMTI_THREAD_STATE_PARKED,
  PARKED_TIMED             = JVMTI_THREAD_STATE_ALIVE +          // LockSupport.park(long)
                             JVMTI_THREAD_STATE_WAITING +
                             JVMTI_THREAD_STATE_WAITING_WITH_TIMEOUT +
                             JVMTI_THREAD_STATE_PARKED,
  BLOCKED_ON_MONITOR_ENTER = JVMTI_THREAD_STATE_ALIVE +          // (re-)entering a synchronization block
                             JVMTI_THREAD_STATE_BLOCKED_ON_MONITOR_ENTER,
  TERMINATED               = JVMTI_THREAD_STATE_TERMINATED
};</code></pre></div>
</div>
<p>
src/share/vm/prims/jvmti.xml</p>
<div class="src src-xml -n 1198">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">&lt;constants id=&#34;jvmtiThreadState&#34; label=&#34;Thread State Flags&#34; kind=&#34;bits&#34;&gt;
  &lt;constant id=&#34;JVMTI_THREAD_STATE_ALIVE&#34; num=&#34;0x0001&#34;&gt;
    Thread is alive. Zero if thread is new (not started) or terminated.
  &lt;/constant&gt;
  &lt;constant id=&#34;JVMTI_THREAD_STATE_TERMINATED&#34; num=&#34;0x0002&#34;&gt;
    Thread has completed execution.
  &lt;/constant&gt;
  &lt;constant id=&#34;JVMTI_THREAD_STATE_RUNNABLE&#34; num=&#34;0x0004&#34;&gt;
    Thread is runnable.
  &lt;/constant&gt;
  &lt;constant id=&#34;JVMTI_THREAD_STATE_BLOCKED_ON_MONITOR_ENTER&#34; num=&#34;0x0400&#34;&gt;
    Thread is waiting to enter a synchronization block/method or,
          after an &lt;code&gt;Object.wait()&lt;/code&gt;, waiting to re-enter a 
          synchronization block/method.
  &lt;/constant&gt;
  &lt;constant id=&#34;JVMTI_THREAD_STATE_WAITING&#34; num=&#34;0x0080&#34;&gt;
    Thread is waiting.
  &lt;/constant&gt;
  &lt;constant id=&#34;JVMTI_THREAD_STATE_WAITING_INDEFINITELY&#34; num=&#34;0x0010&#34;&gt;
    Thread is waiting without a timeout.
          For example, &lt;code&gt;Object.wait()&lt;/code&gt;.
  &lt;/constant&gt;
  &lt;constant id=&#34;JVMTI_THREAD_STATE_WAITING_WITH_TIMEOUT&#34; num=&#34;0x0020&#34;&gt;
    Thread is waiting with a maximum time to wait specified.
          For example, &lt;code&gt;Object.wait(long)&lt;/code&gt;.
  &lt;/constant&gt;
  &lt;constant id=&#34;JVMTI_THREAD_STATE_SLEEPING&#34; num=&#34;0x0040&#34;&gt;
    Thread is sleeping -- &lt;code&gt;Thread.sleep(long)&lt;/code&gt;.
  &lt;/constant&gt;
  &lt;constant id=&#34;JVMTI_THREAD_STATE_IN_OBJECT_WAIT&#34; num=&#34;0x0100&#34;&gt;
    Thread is waiting on an object monitor -- &lt;code&gt;Object.wait&lt;/code&gt;.
  &lt;/constant&gt;
  &lt;constant id=&#34;JVMTI_THREAD_STATE_PARKED&#34; num=&#34;0x0200&#34;&gt;
    Thread is parked, for example: &lt;code&gt;LockSupport.park&lt;/code&gt;,
          &lt;code&gt;LockSupport.parkUtil&lt;/code&gt; and &lt;code&gt;LockSupport.parkNanos&lt;/code&gt;.
  &lt;/constant&gt;
  &lt;constant id=&#34;JVMTI_THREAD_STATE_SUSPENDED&#34; num=&#34;0x100000&#34;&gt;
    Thread suspended.
    &lt;code&gt;java.lang.Thread.suspend()&lt;/code&gt;
    or a &lt;jvmti/&gt; suspend function 
          (such as &lt;functionlink id=&#34;SuspendThread&#34;&gt;&lt;/functionlink&gt;) 
          has been called on the thread. If this bit
    is set, the other bits refer to the thread state before suspension.
  &lt;/constant&gt;
  &lt;constant id=&#34;JVMTI_THREAD_STATE_INTERRUPTED&#34; num=&#34;0x200000&#34;&gt;
    Thread has been interrupted.
  &lt;/constant&gt;
  &lt;constant id=&#34;JVMTI_THREAD_STATE_IN_NATIVE&#34; num=&#34;0x400000&#34;&gt;
          Thread is in native code--that is, a native method is running
          which has not called back into the VM or Java programming
          language code.
          &lt;p/&gt;
          This flag is not set when running VM compiled Java programming
          language code nor is it set when running VM code or
          VM support code. Native VM interface functions, such as JNI and
          &lt;jvmti/&gt; functions, may be implemented as VM code.
  &lt;/constant&gt;
  &lt;constant id=&#34;JVMTI_THREAD_STATE_VENDOR_1&#34; num=&#34;0x10000000&#34;&gt;
          Defined by VM vendor.
  &lt;/constant&gt;
  &lt;constant id=&#34;JVMTI_THREAD_STATE_VENDOR_2&#34; num=&#34;0x20000000&#34;&gt;
          Defined by VM vendor.
  &lt;/constant&gt;
  &lt;constant id=&#34;JVMTI_THREAD_STATE_VENDOR_3&#34; num=&#34;0x40000000&#34;&gt;
          Defined by VM vendor.
  &lt;/constant&gt;
&lt;/constants&gt;</code></pre></div>
</div>
<p>
当一个线程的状态为 225 时，转换成 16 进制则为 e1。
按照公式：</p>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">SLEEPING = JVMTI_THREAD_STATE_ALIVE +          // Thread.sleep()
           JVMTI_THREAD_STATE_WAITING +
           JVMTI_THREAD_STATE_WAITING_WITH_TIMEOUT +
           JVMTI_THREAD_STATE_SLEEPING</code></pre></div>
</div>
<p>
可以发现满足 e1 = 0x0001 + 0x0080 + 0x0020 + 0x0040（这4个数值与 jvmti.xml 一一对应），所以可以推断该线程当时处于 sleep 状态</p>
<p>
另外 threadService.hpp 文件控制了一个线程的 threadStatus，比如 JavaThreadSleepState 该函数就将线程状态修改为 java_lang_Thread::SLEEPING</p>
<div class="src src-cpp">
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#408080;font-style:italic">// Change status to sleeping
</span><span style="color:#408080;font-style:italic"></span><span style="color:#008000;font-weight:bold">class</span> <span style="color:#00f;font-weight:bold">JavaThreadSleepState</span> <span style="color:#666">:</span> <span style="color:#008000;font-weight:bold">public</span> JavaThreadStatusChanger {
 <span style="color:#008000;font-weight:bold">private</span><span style="color:#666">:</span>
  ThreadStatistics<span style="color:#666">*</span> _stat;
  <span style="color:#b00040">bool</span> _active;
 <span style="color:#008000;font-weight:bold">public</span><span style="color:#666">:</span>
  JavaThreadSleepState(JavaThread <span style="color:#666">*</span>java_thread) <span style="color:#666">:</span>
    JavaThreadStatusChanger(java_thread, java_lang_Thread<span style="color:#666">::</span>SLEEPING) {
    <span style="color:#008000;font-weight:bold">if</span> (is_alive()) {
      _stat <span style="color:#666">=</span> java_thread<span style="color:#666">-&gt;</span>get_thread_stat();
      _active <span style="color:#666">=</span> ThreadService<span style="color:#666">::</span>is_thread_monitoring_contention();
      _stat<span style="color:#666">-&gt;</span>thread_sleep();
      <span style="color:#008000;font-weight:bold">if</span> (_active) {
        _stat<span style="color:#666">-&gt;</span>thread_sleep_begin();
      }
    } <span style="color:#008000;font-weight:bold">else</span> {
      _active <span style="color:#666">=</span> <span style="color:#008000">false</span>;
    }
  }

  <span style="color:#666">~</span>JavaThreadSleepState() {
    <span style="color:#008000;font-weight:bold">if</span> (_active) {
      _stat<span style="color:#666">-&gt;</span>thread_sleep_end();
    }
  }
};</code></pre></div>
</div>

        </div>

        <div class="row middle-xs">
          <div class="col-xs-12">
            
          </div>
        </div>
        <div class="row">
          <div class="col-xs-12">
            
          </div>
        </div>

        
        

        
        
        <div style="height: 50px;"></div>
        
        

        <div class="site-footer">
  
  <div class="site-footer-item">
    <a href="https://github.com/idreamshen" target="_blank">Github</a>
  </div>
  
  <div class="site-footer-item">
    <a href="mailto:idream.shen@gmail.com" target="_blank">Email</a>
  </div>
  
  
</div>

      </div>
    </div>
  </article>

  <script src="/js/highlight.pack.js"></script>


<script>
  hljs.initHighlightingOnLoad();
  
  
  
    
    
  
</script>

  

</body>

</html>